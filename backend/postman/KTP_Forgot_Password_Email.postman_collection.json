{
  "info": {
    "name": "KTP - Forgot Password & Email",
    "description": "Test cases for Forgot Password and Reset Password functionality with real email sending via Nodemailer + Gmail SMTP",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Forgot Password - Valid Email",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has success status\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('success');",
              "});",
              "",
              "pm.test(\"Success message mentions email\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.message).to.include('email');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"user@example.com\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/forgot-password",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "forgot-password"]
        },
        "description": "Request password reset for a valid user email. Email will be sent to the provided address."
      },
      "response": []
    },
    {
      "name": "2. Forgot Password - Non-existent Email",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200 (security: don't reveal if email exists)\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has success status\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('success');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"nonexistent@example.com\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/forgot-password",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "forgot-password"]
        },
        "description": "Request password reset for non-existent email. For security, returns same success message but no email is actually sent."
      },
      "response": []
    },
    {
      "name": "3. Forgot Password - Missing Email",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 400\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('fail');",
              "    pm.expect(jsonData.message).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/forgot-password",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "forgot-password"]
        },
        "description": "Request with empty email should fail with 400 error."
      },
      "response": []
    },
    {
      "name": "4. Reset Password - Valid Token",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has success status\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('success');",
              "});",
              "",
              "pm.test(\"Access token returned\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.accessToken).to.exist;",
              "});",
              "",
              "pm.test(\"Refresh token returned\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.refreshToken).to.exist;",
              "});",
              "",
              "pm.test(\"User object returned\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.user).to.exist;",
              "    pm.expect(jsonData.user.email).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"password\": \"newpassword123\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/reset-password/:token",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "reset-password", ":token"]
        },
        "description": "Reset password using valid token from email. Replace :token with actual token from email.\n\nSteps:\n1. First run 'Forgot Password - Valid Email'\n2. Check your email inbox (or spam)\n3. Copy the token from the email link (after ?token=)\n4. Paste it in the :token parameter above\n5. Run this request"
      },
      "response": []
    },
    {
      "name": "5. Reset Password - Invalid Token",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 400\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message about invalid token\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('fail');",
              "    pm.expect(jsonData.message).to.include('Token');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"password\": \"newpassword123\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/reset-password/invalidtoken123",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "reset-password", "invalidtoken123"]
        },
        "description": "Attempt to reset password with invalid/fake token. Should fail with 400 error."
      },
      "response": []
    },
    {
      "name": "6. Reset Password - Expired Token",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 400\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message about expired token\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('fail');",
              "    pm.expect(jsonData.message).to.include('hết hạn');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"password\": \"newpassword123\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/reset-password/:expiredToken",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "reset-password", ":expiredToken"]
        },
        "description": "Test with a token that has expired (older than 10 minutes).\n\nTo test:\n1. Request forgot password\n2. Wait 10+ minutes\n3. Try to use the token\n4. Should fail with expired message"
      },
      "response": []
    },
    {
      "name": "7. Reset Password - Missing Password",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 400\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message about password\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('fail');",
              "    pm.expect(jsonData.message).to.include('mật khẩu');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"password\": \"\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/reset-password/sometoken",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "reset-password", "sometoken"]
        },
        "description": "Attempt to reset with empty password. Should fail with validation error."
      },
      "response": []
    },
    {
      "name": "8. Reset Password - Weak Password",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 400\", function () {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test(\"Error message about password length\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('fail');",
              "    pm.expect(jsonData.message).to.include('6 ký tự');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"password\": \"123\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/reset-password/sometoken",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "reset-password", "sometoken"]
        },
        "description": "Attempt to reset with password shorter than 6 characters. Should fail with validation error."
      },
      "response": []
    },
    {
      "name": "9. Login with New Password",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Login successful with new password\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('success');",
              "    pm.expect(jsonData.accessToken).to.exist;",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"newpassword123\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "login"]
        },
        "description": "Verify that you can login with the new password after reset.\n\nSteps:\n1. Complete reset password flow (requests 1 and 4)\n2. Use the new password to login\n3. Should succeed"
      },
      "response": []
    },
    {
      "name": "10. Multiple Reset Requests",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Each request generates new token\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.status).to.eql('success');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"user@example.com\"\n}"
        },
        "url": {
          "raw": "http://localhost:3000/api/auth/forgot-password",
          "protocol": "http",
          "host": ["localhost"],
          "port": "3000",
          "path": ["api", "auth", "forgot-password"]
        },
        "description": "Test requesting password reset multiple times.\n\nExpected behavior:\n- Each request generates a NEW token\n- Previous tokens become invalid\n- Only the LATEST token works\n\nTest:\n1. Run this request multiple times\n2. Try to use an old token\n3. Should fail\n4. Use the latest token\n5. Should succeed"
      },
      "response": []
    }
  ]
}
